<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astro-Bio Dynamics Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Base Colors & Neon Theme */
        :root {
            --color-primary-dark: #0d121c; /* Deep Space Black */
            --color-console-bg: #151a24; /* Console Dark Blue/Gray */
            --color-accent: #4dc0c5; /* Neon Blue */
            --color-text-light: #e5e7eb; /* Light Text */
            --color-input-bg: #1f2937; /* Dark Input Gray */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-primary-dark);
            background-image: radial-gradient(circle at center, rgba(30, 41, 59, 0.2) 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--color-text-light);
        }

        /* Neon Header Glow */
        .title-accent {
            text-shadow: 0 0 10px var(--color-accent), 0 0 5px rgba(77, 192, 197, 0.7);
        }

        /* Custom scrollbar */
        #chat-window::-webkit-scrollbar { width: 6px; }
        #chat-window::-webkit-scrollbar-thumb {
            background-color: var(--color-accent);
            border-radius: 3px;
        }
        #chat-window::-webkit-scrollbar-track { background-color: var(--color-console-bg); }

        /* Search Bar Styling (Dark & Glowing) */
        .search-bar {
            background-color: var(--color-input-bg);
            border: 1px solid #374151;
            transition: all 0.3s;
        }
        .search-bar:focus-within {
            box-shadow: 0 0 15px rgba(77, 192, 197, 0.6); /* Neon Glow on focus */
            border-color: var(--color-accent);
        }
        .search-bar input {
             color: var(--color-text-light);
             background-color: transparent;
        }
        .search-bar input::placeholder {
             color: #9ca3af; /* Gray-400 */
        }

        /* Result Card Styling (Dark Console style) */
        .result-card {
            background-color: var(--color-console-bg);
            border-left: 4px solid var(--color-accent);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .result-card a {
            color: var(--color-accent);
            text-shadow: 0 0 3px rgba(77, 192, 197, 0.5);
        }
        
        /* New style for the interactive tabs */
        .tab-button {
            padding: 8px 16px;
            border-radius: 9999px; /* full rounded */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: var(--color-accent);
            background-color: #1f2937; /* Dark gray background */
            border: 1px solid var(--color-accent);
            box-shadow: 0 0 5px rgba(77, 192, 197, 0.4);
            transition: all 0.2s;
            white-space: nowrap; /* Prevents wrapping text on small buttons */
        }
        .tab-button:hover {
            background-color: var(--color-accent);
            color: #151a24; /* Dark text on neon hover */
            box-shadow: 0 0 10px var(--color-accent);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased">

    <div class="flex-grow w-full max-w-4xl mx-auto p-4 md:p-8 flex flex-col">
        
        <!-- High-Tech Header -->
        <header class="text-center pt-8 pb-4 mb-8 border-b border-gray-700/50">
            <h1 class="text-3xl md:text-4xl font-extrabold title-accent tracking-widest uppercase text-white">
                ASTRO-BIO DYNAMICS
            </h1>
            <p class="text-sm text-gray-500 mt-2">
                Grounding Engine v2.1 // Secure Data Access
            </p>
        </header>

        <!-- Search Bar / Input Area (Chrome layout, Neon style) -->
        <div class="search-bar flex items-center rounded-full p-2 mb-4 mx-auto w-full md:max-w-3xl">
            <input type="text" id="user-input" placeholder="Enter research query (e.g., radiation effects on human DNA)"
                   class="flex-grow p-3 ml-5 text-lg focus:outline-none">
            
            <button id="send-button" onclick="sendMessage()"
                    class="bg-accent text-gray-900 font-medium py-3 px-6 rounded-full hover:opacity-80 transition duration-150 disabled:opacity-50 flex items-center justify-center mr-1 shadow-lg shadow-cyan-900/50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </button>
        </div>

        <!-- News/Category Tabs -->
        <div class="flex flex-wrap justify-center gap-3 mb-8">
            <button onclick="setQuery('Microgravity Effects')" class="tab-button">Microgravity Effects</button>
            <button onclick="setQuery('Space Radiation Risk')" class="tab-button">Space Radiation Risk</button>
            <button onclick="setQuery('Astrobiology Missions')" class="tab-button">Astrobiology Missions</button>
            <button onclick="setQuery('ISS Plant Growth')" class="tab-button">ISS Plant Growth</button>
        </div>

        <!-- Chat Window (Search Results Feed) -->
        <div id="chat-window" class="flex-grow overflow-y-auto p-4 space-y-6">
            <!-- Initial Bot Message -->
            <div class="flex justify-start">
                <div class="result-card p-5 rounded-xl shadow-sm max-w-3xl w-full">
                    <p class="text-sm text-gray-400 mb-1">terminal-interface://gsbe.com</p>
                    <p class="text-xl font-medium" style="color: var(--color-accent);">Astro-Bio Dynamics Terminal Initialized</p>
                    <p class="mt-2 text-gray-300">Welcome. This engine provides real-time, cited scientific data on the biological challenges of long-duration spaceflight. Input your query above to proceed with data retrieval.</p>
                </div>
            </div>
            <!-- Messages/Results will be injected here -->
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="mt-4 text-center hidden">
            <div class="flex items-center justify-center space-x-2">
                <div class="w-3 h-3 rounded-full animate-pulse" style="background-color: var(--color-accent);"></div>
                <div class="w-3 h-3 rounded-full animate-pulse animation-delay-150" style="background-color: var(--color-accent);"></div>
                <div class="w-3 h-3 rounded-full animate-pulse animation-delay-300" style="background-color: var(--color-accent);"></div>
                <span class="text-sm text-gray-400 tracking-wider ml-3">EXECUTING SEARCH PROTOCOL...</span>
            </div>
        </div>
    </div>

    <script type="module">
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = ""; // Canvas will automatically provide the API key
        
        // --- UI Elements ---
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- Core Functions ---
        
        /**
         * Sets the search bar input with a predefined query.
         * @param {string} query The query text.
         */
        window.setQuery = function(query) {
            userInput.value = query;
            userInput.focus();
        }

        /**
         * Utility to display a message in the chat window, styled as a search result.
         * @param {string} text The message content.
         * @param {string} sender 'user' or 'bot'.
         * @param {Array<Object>} [sources=[]] Array of grounding sources.
         */
        function displayMessage(text, sender, sources = []) {
            const messageDiv = document.createElement('div');
            
            // User query is displayed as a subtle link/text above the search result.
            if (sender === 'user') {
                messageDiv.className = 'flex justify-start'; 
                messageDiv.innerHTML = `<p class="text-sm text-gray-500 mb-1 pl-4 pt-4">
                    <span style="color: var(--color-accent); cursor: pointer;" onclick="document.getElementById('user-input').value = this.textContent.slice(2).trim(); document.getElementById('user-input').focus();">
                        // ${text}
                    </span>
                </p>`;
                chatWindow.appendChild(messageDiv);
            } else {
                const bubbleBase = 'p-5 rounded-xl shadow-sm transition duration-300 w-full';
                const bubbleClass = 'result-card max-w-3xl';

                const name = 'terminal-interface://gsbe.com';
                const linkTitle = 'DATA RESULT: Space Biology Grounding Report';

                let contentHTML = `<p class="text-sm text-gray-400 mb-1">${name}</p>`;
                contentHTML += `<p class="text-xl font-medium mb-2" style="color: var(--color-accent);">${linkTitle}</p>`;
                contentHTML += `<p class="text-gray-300">${text}</p>`;

                if (sources.length > 0) {
                    const sourceList = sources.map((s, index) => 
                        `<li class="truncate text-gray-500"><a href="${s.uri}" target="_blank" class="text-xs hover:underline" style="color: var(--color-accent);">${s.title}</a></li>`
                    ).join('');

                    contentHTML += `<div class="mt-3 pt-3 border-t border-gray-700">
                        <p class="text-sm font-semibold text-gray-500 mb-1">Grounded Source Attributions:</p>
                        <ul class="list-none space-y-1 text-sm pl-0">${sourceList}</ul>
                    </div>`;
                }

                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = `${bubbleBase} ${bubbleClass}`;
                bubbleDiv.innerHTML = contentHTML;

                messageDiv.className = 'flex justify-start';
                messageDiv.appendChild(bubbleDiv);
                chatWindow.appendChild(messageDiv);
            }

            // Auto-scroll to the bottom
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        
        /**
         * Calls the Gemini API with exponential backoff for reliability.
         * @param {Object} payload The API request body.
         * @param {number} [retries=3] Max number of retries.
         * @param {number} [delay=1000] Initial delay in ms.
         * @returns {Promise<Object>} The parsed JSON response.
         */
        async function callGeminiAPI(payload, retries = 3, delay = 1000) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    } else if (response.status === 429 && i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    } else {
                        throw new Error(`API call failed with status ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        console.error("Gemini API call failed after multiple retries:", error);
                        throw new Error("Could not connect to the Knowledge Engine. Please try again later.");
                    }
                }
            }
        }

        /**
         * Handles user message submission, API call, and displaying results.
         */
        window.sendMessage = async function() {
            const userQuery = userInput.value.trim();
            if (userQuery === "") return;

            // 1. Display user query as a command/text
            displayMessage(userQuery, 'user');
            
            // Clear input after capturing query
            userInput.value = '';
            
            // 2. Set loading state
            sendButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            const systemPrompt = "You are a specialized Space Biology Knowledge Engine, referred to as the 'Astro-Bio Dynamics Terminal'. Your purpose is to provide detailed, accurate, and grounded answers about how biological life (humans, animals, plants, microbes) is affected by the space environment (microgravity, radiation, isolation, etc.). Your response must be in paragraph format, suitable for a professional data report or search result snippet. Use Google Search grounding to ensure accuracy and provide citations.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const result = await callGeminiAPI(payload);
                const candidate = result.candidates?.[0];
                let botResponseText = "ERROR: Unable to retrieve data. The search returned no reliable results for that query. Please try searching for a different term.";
                let sources = [];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    botResponseText = candidate.content.parts[0].text;

                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                }

                // 3. Display bot message as a search result card
                displayMessage(botResponseText, 'bot', sources);

            } catch (error) {
                console.error("Error during message processing:", error);
                displayMessage(`WARNING: Connection failure detected: ${error.message}. Search service temporarily offline.`, 'bot');
            } finally {
                // 4. Reset loading state
                sendButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                userInput.focus();
            }
        };

        // Event listener for 'Enter' key
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Initial focus on load
        window.onload = () => userInput.focus();

    </script>
</body>
</html>
